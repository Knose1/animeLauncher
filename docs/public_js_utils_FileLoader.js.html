<!-- start:source.tmpl.hbs -->
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
		<title>public/js/utils/FileLoader.js</title>
		<link rel="icon" type="image/png" href="favicon.png"/>
		<!--[if lt IE 9]>
		<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
		<link href="https://fonts.googleapis.com/css?family=PT+Mono" rel="stylesheet">
		<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css">
		<link type="text/css" rel="stylesheet" href="css/prism.min.css">
		<link type="text/css" rel="stylesheet" href="css/template.min.css">
			<link type="text/css" rel="stylesheet" href="./jsdocCustomScripts/index.css">
			<link type="text/css" rel="stylesheet" href="./jsdocCustomScripts/dark.css">
			<style>
				.page-header,
				pre.code-toolbar > .toolbar:hover {
					background-color: hsl(150, 56%, 46%);
				}
				.callout-primary,
				.toc .nav > li > a:hover,
				.toc .nav > li > a:focus,
				.toc .nav > li.active > a,
				.toc .nav > li.active > a:hover,
				.toc .nav > li.active > a:focus,
				pre.code-toolbar > .toolbar:hover {
					border-left-color: hsl(150, 56%, 46%);
				}
				pre.code-toolbar > .toolbar:hover {
					border-bottom-color: hsl(150, 56%, 46%);
				}
				.callout-primary h5,
				.symbol-title.collapsible-symbol .toggle-icon,
				.breadcrumb li a,
				.toc .nav > li > a:hover,
				.toc .nav > li > a:focus,
				.toc .nav > li.active > a,
				.toc .nav > li.active > a:hover,
				.toc .nav > li.active > a:focus {
					color: hsl(150, 56%, 46%);
				}
			</style>
		<script type="text/javascript">
			window.TEMPLATE_OPTIONS = {"includeDate":true,"dateFormat":"Do MMM YYYY","systemName":"Anime Launcher","systemSummary":"Documentation","systemLogo":"img/ico_64.png","systemColor":"hsl(150, 56%, 46%)","navMembers":[{"kind":"class","title":"Classes","summary":"All documented classes."},{"kind":"external","title":"Externals","summary":"All documented external members."},{"kind":"mixin","title":"Mixins","summary":"All documented mixins."},{"kind":"interface","title":"Interfaces","summary":"All documented interfaces."},{"kind":"module","title":"Modules","summary":"All documented modules."},{"kind":"namespace","title":"Namespaces","summary":"All documented namespaces."},{"kind":"tutorial","title":"Tutorials","summary":"All available tutorials."}],"footer":"","copyright":"Anime Launcher is licensed under MIT <a href=\"https://github.com/Knose1/animeLauncher/blob/master/LICENSE\">license</a>. Copyright (c) 2020 <a href=\"https://github.com/Knose1/\">Knose1</a>","linenums":true,"collapseSymbols":true,"inverseNav":true,"inlineNav":false,"outputSourceFiles":true,"sourceRootPath":null,"disablePackagePath":true,"outputSourcePath":false,"showTableOfContents":true,"showAccessFilter":true,"analytics":null,"methodHeadingReturns":true,"sort":"linenum, longname, version, since","search":true,"favicon":"favicon.png","stylesheets":["./jsdocCustomScripts/index.css","./jsdocCustomScripts/dark.css"],"scripts":["./jsdocCustomScripts/jsColorUtils.js","./jsdocCustomScripts/index.js"],"monospaceLinks":true,"cleverLinks":false,"useLongnameInNav":false};
			window.DOCLET_TOC_ENABLED = false;
			window.DOCLET_AFILTER_ENABLED = false;
		</script>
</head>
<body>
	<!-- start:navbar.hbs -->
	<header class="navbar navbar-default navbar-fixed-top navbar-inverse">
		<div class="container">
			<div class="navbar-header">
				<a class="navbar-brand branding-logo" href="index.html" style="background-image: url(img/ico_64.png);">
					Anime Launcher
				</a>
				<!-- displayed on small devices -->
				<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
			</div>
			<div class="navbar-collapse collapse" id="topNavigation">
				<ul class="nav navbar-nav">
								<li class="dropdown">
									<a href="list_class.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="AnimeVideoElement.html">AnimeVideoElement</a></li>
											<li><a href="Public.Common.FileLoader.html">Public.Common.FileLoader</a></li>
											<li><a href="Public.Common.FileLoader.FileToLoad.html">Public.Common.FileLoader.FileToLoad</a></li>
											<li><a href="Public.Common.Point.html">Public.Common.Point</a></li>
											<li><a href="Public.Html.Elements.ButtonElement.html">Public.Html.Elements.ButtonElement</a></li>
											<li><a href="Public.Html.Elements.InputElement.html">Public.Html.Elements.InputElement</a></li>
											<li><a href="Public.Html.Elements.MenuButtonElement.html">Public.Html.Elements.MenuButtonElement</a></li>
											<li><a href="Public.Html.Elements.Personalised.AnimeElement.html">Public.Html.Elements.Personalised.AnimeElement</a></li>
											<li><a href="Public.Html.Elements.Personalised.DownloadAllButton.html">Public.Html.Elements.Personalised.DownloadAllButton</a></li>
											<li><a href="Public.Html.Elements.Personalised.EpisodeDlErrorProgress.html">Public.Html.Elements.Personalised.EpisodeDlErrorProgress</a></li>
											<li><a href="Public.Html.Elements.Personalised.EpisodeDlProgress.html">Public.Html.Elements.Personalised.EpisodeDlProgress</a></li>
											<li><a href="Public.Html.Elements.Personalised.EpisodeElement.html">Public.Html.Elements.Personalised.EpisodeElement</a></li>
											<li><a href="Public.Html.Elements.Personalised.EpisodeInfoElement.html">Public.Html.Elements.Personalised.EpisodeInfoElement</a></li>
											<li><a href="Public.Html.Elements.Personalised.EpisodeWatchButton.html">Public.Html.Elements.Personalised.EpisodeWatchButton</a></li>
											<li><a href="Public.Html.Elements.Personalised.IframeDownloadPromiseElement.html">Public.Html.Elements.Personalised.IframeDownloadPromiseElement</a></li>
											<li><a href="Public.Html.Elements.Personalised.PlayerInfoElement.html">Public.Html.Elements.Personalised.PlayerInfoElement</a></li>
											<li><a href="Public.Html.Elements.Personalised.ReturnButton.html">Public.Html.Elements.Personalised.ReturnButton</a></li>
											<li><a href="Public.Html.Elements.Personalised.YtDlFormatElement.html">Public.Html.Elements.Personalised.YtDlFormatElement</a></li>
											<li><a href="Public.Html.Elements.ProgressBarIndicator.html">Public.Html.Elements.ProgressBarIndicator</a></li>
											<li><a href="Public.Html.Elements.ProgressIndicator.html">Public.Html.Elements.ProgressIndicator</a></li>
											<li><a href="Public.Html.Elements.ScreenElement.html">Public.Html.Elements.ScreenElement</a></li>
											<li><a href="Public.Html.Elements.ScreenElementFromElement.html">Public.Html.Elements.ScreenElementFromElement</a></li>
											<li><a href="Public.Html.Elements.ScreenElementManager.html">Public.Html.Elements.ScreenElementManager</a></li>
											<li><a href="Public.Html.Elements.SrcElement.html">Public.Html.Elements.SrcElement</a></li>
											<li><a href="Public.Html.HTMLManager.html">Public.Html.HTMLManager</a></li>
											<li><a href="Public.Html.ScreenManager.html">Public.Html.ScreenManager</a></li>
											<li><a href="Public.Loader.html">Public.Loader</a></li>
											<li><a href="Public.Main.html">Public.Main</a></li>
											<li><a href="server.Anime.html">server.Anime</a></li>
											<li><a href="server.DownloadEpisode.html">server.DownloadEpisode</a></li>
											<li><a href="server.Episode.html">server.Episode</a></li>
											<li><a href="server.JsonObject.html">server.JsonObject</a></li>
											<li><a href="server.VideoPlayer.html">server.VideoPlayer</a></li>
											<li><a href="server.YoutubePlayer.html">server.YoutubePlayer</a></li>
											<li><a href="VideoElement.html">VideoElement</a></li>
									</ul>
								</li>
								<li class="dropdown">
									<a href="list_namespace.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="Public.html">Public</a></li>
											<li><a href="Public.Common.html">Public.Common</a></li>
											<li><a href="Public.Html.html">Public.Html</a></li>
											<li><a href="Public.Html.Elements.html">Public.Html.Elements</a></li>
											<li><a href="Public.Html.Elements.Personalised.html">Public.Html.Elements.Personalised</a></li>
											<li><a href="server.html">server</a></li>
											<li><a href="server.data.html">server.data</a></li>
											<li><a href="server.data.config.html">server.data.config</a></li>
											<li><a href="server.data.public.html">server.data.public</a></li>
											<li><a href="server.global.html">server.global</a></li>
											<li><a href="server.https.html">server.https</a></li>
											<li><a href="server.image.html">server.image</a></li>
									</ul>
								</li>
				</ul>
					<!-- start:lunr-search-navbar.hbs -->
					<form class="navbar-form navbar-right" role="search">
						<div class="input-group">
							<input type="text" class="form-control" placeholder="Search" id="lunr-search-input">
							<div class="input-group-btn">
								<button class="btn btn-default" id="lunr-search-submit">
									<i class="glyphicon glyphicon-search"></i>
								</button>
							</div>
						</div>
					</form>
					<!-- start:lunr-search-navbar.hbs -->		</div>
		</div>
	</header>
	<!-- end:navbar.hbs -->		<div class="page-header">
			<div class="container">
				<span class="kind">source</span>
				<h1><span class="name">public/js/utils/FileLoader.js</span></h1>
			</div>
		</div>
	<div class="container content">
		<div class="row">
			<div class="col-md-12 main-content">
		<section class="source-section">
			<article></article>
			<pre class="prettyprint source language-javascript line-numbers"><code class="language-javascript">import FileToLoad from './FileToLoad.js';

const STATUS_OK = 200;

const RESET = -2;
const START = -1;

/**
	FileLoader can load files and send their responce using calbacks.
	It can load text, json, html or blob. See : {@link FileToLoad FileToLoad} 
	* @memberof Public.Common
	@example
	```javascript
		function init() {
			FileLoader.getInstance().readAsText('./leveldesign.json', (pD) => {
				LevelManager.init(pD);
			});
			FileLoader.getInstance().oncomplete = () => { FlowManager.showMainMenu() };
	
			FileLoader.getInstance().start();
		}
	```
*/
class FileLoader {
	//static _instance;
	//_currentLoadingItemIndex;
	//loadList;

	//onerror
	//onparseerror
	//oncomplete
	//onprogress
	
	/**
	 * @returns {FileLoader}
	 */
	static getInstance() {
		return FileLoader._instance || (FileLoader._instance = new FileLoader());
	}

	/*
		Constructor
	*/
	constructor() {
		this._reset();

		/**
		 * True if not started or not ended
		 */
		this.isComplete = true;

		/**
		 * @callback Next
		 * @returns {void}
		 * @memberof Public.Common.FileLoader
		 */
		/**
		 * @callback Reset
		 * @returns {void}
		 * @memberof Public.Common.FileLoader
		 */

		/** 
		 * @callback onerror
		 * @param {Error} pErr
		 * @param {Next} pNext
		 * @param {Reset} pReset
		 * @param {number} pCurrentLoadingItemIndex
		 * @returns {void}
		 * @memberof Public.Common.FileLoader
		 */
		/**
		 * @type {onerror}
		 */
		this.onerror = null;

		/** 
		 * @callback onparseerror
		 * @param {Error} pErr
		 * @param {Next} pNext
		 * @param {Reset} pReset
		 * @param {number} pCurrentLoadingItemIndex
		 * @returns {void}
		 * @memberof Public.Common.FileLoader
		 */
		/**
		 * @type {onparseerror}
		 */
		this.onparseerror = null;
		
		/** 
		 * @callback oncomplete
		 * @returns {void}
		 * @memberof Public.Common.FileLoader
		 */
		/**
		 * @type {oncomplete}
		 */
		this.oncomplete = null;
		
		/** 
		 * @callback onprogress
		 * @param {number} pProgress
		 * @returns {void}
		 * @memberof Public.Common.FileLoader
		 */
		/**
		 * @type {onprogress}
		 */
		this.onprogress = null;

		/**
		 * @type {FileToLoad[]}
		 */
		this.loadList = [];
	}

	/**
	 * @protected
	 */
	_destroy()
	{
		if (FileLoader._instance == this) 
		{
			FileLoader._instance = null;
		}
		this._reset();
	}
	
	/**
	 * @callback TextDataCallback
	 * @param {string} pData
	 * @return {void}
	 * @memberof Public.Common.FileLoader
	 */

	/**
	 * Renvoie une chaine de charactère contenant le contenu du fichier
	 * @param {string} pURL
	 * @param {TextDataCallback} pCallback
	 */
	readAsText(pURL, pCallback) {
		this.loadList.push(new FileToLoad(
			pURL,
			FileToLoad.getTYPE_TEXT(),
			pCallback
		));
		return this;
	}



	/**
	 * @callback JsonDataCallback
	 * @param {*} pData
	 * @return {void}
	 * @memberof Public.Common.FileLoader
	 */

	/**
	 * Renvoie l'object json contenu dans le fichier
	 * @param {string} pURL
	 * @param {JsonDataCallback} pCallback
	 */
	readAsJson(pURL, pCallback) {
		this.loadList.push(new FileToLoad(
			pURL,
			FileToLoad.getTYPE_JSON(),
			pCallback
		));
		return this;
	}



	/**
	 * @callback HTMLDataCallback
	 * @param {Document} pData
	 * @return {void}
	 * @memberof Public.Common.FileLoader
	 */

	/**
	 * Renvoie le document html contenu dans le fichier
	 * @param {string} pURL
	 * @param {HTMLDataCallback} pCallback
	 */
	readAsHTML(pURL, pCallback) {
		this.loadList.push(new FileToLoad(
			pURL,
			FileToLoad.getTYPE_HTML(),
			pCallback
		));
		return this;
	}

	/**
	 * @callback BlobDataCallback
	 * @param {string} pData
	 * @return {void}
	 * @memberof Public.Common.FileLoader
	 */

	/**
	 * Renvoie un url blob pointant vers le fichier stocké en cache
	 * @param {string} pURL
	 * @param {BlobDataCallback} pCallback
	 */
	readAsBlob(pURL, pCallback) {
		this.loadList.push(new FileToLoad(
			pURL,
			FileToLoad.getTYPE_BLOB(),
			pCallback
		));
		return this;
	}

	start() {
		this.isComplete = false;
		this._currentLoadingItemIndex = START;
		this._callNext();
	}

	_reset() {
		this._currentLoadingItemIndex = RESET;
		this.loadList = [];
		return this;
	}
	

	_callNext() {
		if (this._currentLoadingItemIndex &lt; START) return;



		this._currentLoadingItemIndex++;

		//Si on est arrivé à la fin de la loadlist, on execute oncomplete
		if (this._currentLoadingItemIndex >= this.loadList.length) {
			if (this.oncomplete instanceof Function) this.oncomplete();
			this.isComplete = true;
			//this._destroy();
			return;
		}
		


		//On execute onprogress lorsque l'on charge un nouveau fichier
		let lProgress = this._currentLoadingItemIndex / this.loadList.length;
		if (this.onprogress instanceof Function) this.onprogress(lProgress);


		let currentLoadingItem = this.loadList[this._currentLoadingItemIndex];
		
		/**
		 * 
		 * @param {Error} pErr 
		 */
		let lCatchFunction = (pCalback, pErr) => {
			console.error(pErr, currentLoadingItem);

			if (pCalback instanceof Function) pCalback(pErr, this._callNext.bind(this), this._reset.bind(this), this._currentLoadingItemIndex);
		}

		//On récupère le contenu du fichier
		fetch(currentLoadingItem.url)
		.then((pResult) => {
			if (pResult.status !== STATUS_OK) {
				lCatchFunction(this.onerror, new Error(pResult.status+" "+pResult.statusText+" : " + pResult.url));
				return;
			}

			/*
				On parse le résultat en text ou en blob en fonction de la réponse
			*/
			
			/**
			 * @type {Promise&lt;*>}
			 */
			let lFunction = null;

			switch (currentLoadingItem.type) {
				case FileToLoad.getTYPE_HTML():
				case FileToLoad.getTYPE_TEXT():
					lFunction = pResult.text();
					break;

				case FileToLoad.getTYPE_BLOB():
					lFunction = pResult.blob();
					break;

				case FileToLoad.getTYPE_JSON():
					
					lFunction = pResult.text().then(txt => {
						console.group("JSON");
						console.log(txt);
						return JSON.parse(txt);
					})
					.catch( e => {
						console.log(e);
					})
					.finally( () => console.groupEnd() );
					break;
			}

			lFunction.then(
				(pData) => {

					switch (currentLoadingItem.type) {
						case FileToLoad.getTYPE_BLOB():
							this._createUrlAndSendResult(pData, currentLoadingItem)
							break;
						
						case FileToLoad.getTYPE_HTML():
							this._parseAsHtmlAndSendResult(pData, currentLoadingItem);
							break;

						default:
							this._directSendResult(pData, currentLoadingItem)
							break;
					}

					this._callNext();
				}
				
			)
			.catch( lCatchFunction.bind(this, this.onparseerror) );
		})
		.catch( lCatchFunction.bind(this, this.onerror) );
		
	}

	_directSendResult(pData, pCurrentLoadingItem) {
		pCurrentLoadingItem.callback(pData);
	}

	_createUrlAndSendResult(pData, pCurrentLoadingItem) {
		pCurrentLoadingItem.callback(URL.createObjectURL(pData));
	}

	_parseAsHtmlAndSendResult(pData, pCurrentLoadingItem)
	{
		// Convert the HTML string into a document object
		var parser = new DOMParser();
		var doc = parser.parseFromString(pData, 'text/html');

		pCurrentLoadingItem(doc);
	}
}

export default FileLoader;</code></pre>
		</section>
			</div>
		</div>
	</div>
	<footer>
				<div class="copyright">Anime Launcher is licensed under MIT <a href="https://github.com/Knose1/animeLauncher/blob/master/LICENSE">license</a>. Copyright (c) 2020 <a href="https://github.com/Knose1/">Knose1</a></div>
			<div class="generated-by">Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on 19th Dec 2020 using the <a href="https://github.com/steveush/foodoc">FooDoc template</a>.</div>
	</footer>
	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/clipboard.min.js"></script>
	<script src="js/prism.min.js"></script>
	<script src="js/template.min.js"></script>
		<!-- start:lunr-search-modal.hbs -->
		<div class="modal fade" id="lunr-search-modal">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Search results</h4>
					</div>
					<div class="modal-body" id="lunr-search-body">
					</div>
					<div class="modal-footer" id="lunr-search-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div>
		<!-- end:lunr-search-modal.hbs -->		<script src="js/lunr.min.js"></script>
		<script src="./jsdocCustomScripts/jsColorUtils.js"></script>
		<script src="./jsdocCustomScripts/index.js"></script>
	
</body>
</html>
<!-- end:source.tmpl.hbs -->